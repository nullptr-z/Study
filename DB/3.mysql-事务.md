## 事务四大特性-ACID

原子性、一致性、隔离性、持久性，实际上这三种特性都是为了**一致性**

## 原子性

要么全部成功，要么全部失败

配合 undolog 实现

假设有 3 条 SQL 语句组成一个事务，其中任意一条失败，回滚所有 sql 执行记录

## 隔离性

多个事务之间的操作不会互相干扰

通过 MVCC、锁实现

## 持久性

存储到磁盘便可以持久。

还通过借助 redolog 实现，快速持久化

场景：

> 要在 10 亿行表的数据中，修改其中一行，需要先找到这条数据，再进行修改，这是很慢的；
> 如果再出现并发，都要进行修改，那么效率更是低下；
> 只需要先记录下来这些操作记录下来，记录临时文件 redolog。之后空闲的时候再慢慢去执行这些操作,真正的数据库文件

## 幻读

如果事务中全部都是快照读，那么不会产生幻读；
RR 并发控制模式下，`快照读`和`当前读`混合使用产生的

select 在只在第一次触发`当前读`,之后都是`快照读`
update delete insert 语句触发`当前读`

## 事务锁

阻塞增删改, 解决幻读问题

```sql
mysql> begin;
-- 加锁
select ... from ... for update 加锁
-- 查看锁，在TRANSACTIONS模块
mysql> show engine innodb status\G
```

### 二阶段提交

- 准备阶段：事务对数据库的修改操作写入 redolog，并将这个状态标记为“准备（prepare）”状态，但这些修改还未应用到数据库文件。
- 提交阶段：一旦所有相关操作都准备就绪，事务会被提交。提交时，事务的修改被标记为“提交（commit）”状态，并将此状态写入到 binlog。之后，事务的修改才真正地应用到数据库文件中。
- 保证了原子性

和操作系统的日志文件系统异曲同工，都利用了日志（日志文件）来保证系统在遇到故障时能够恢复到一个一致的状态。无论是数据库的二阶段提交，还是操作系统的日志文件系统
核心思想都是“先记日志，后写数据”，通过这种方式，即使在发生系统崩溃的情况下，例如写到一半断电了，也能够利用日志数据恢复到最后一次提交的状态，从而保证数据的一致性和系统的可靠性。
