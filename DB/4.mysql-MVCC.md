多版本并发控制 Multiply Version Concurrent Control

一种无锁并发控制机制，因为锁会影响性能，所以通过 MVCC 减少锁的使用；

- 版本控制：通过为数据的每次修改创建新的版本，同时保留旧版本，来支持并发访问。
- Undo Log：记录数据的旧版本，支持数据的回滚操作，并为 MVCC 提供必要的数据版本。
- Read View：确定事务可以看到哪些数据版本，保证了读取操作的一致性。

## 理解 MVCC

并发类型：

- 读读: 无数据安全问题
- 读写: 造成脏读、幻读、不可重复读
- 写写: 更新丢失

- 当前读，读取的最新数据
- 快照读，读取的是历史版本数据

## 隔离级别-可见性

RR: 可重复读，默认
RC：读取已提交

## 1.隐藏字段

数据库表中，除了我们定义的字段，还包含：

- DB_RTX_ID: 最近执行了创建、修改的那个事务的 ID
- DB_ROLL_PTR：回滚指针，指向这条数据的上一个版本，在 undolog 中
- DB_ROW_ID：数据行号，也叫隐藏主键，6 字节

## 2.回滚日志 undolog

保留了多条历史日志的链

多条事务，对一条数据记录做修改时，会形成一条线性旧数据的日志链，链首就是最新的记录，链尾是最早的记录

## 3.读视图 Read View

事务在进行`快照读`时产生的视图信息

- trx_list: 当前系统中活跃的事务 ID
- up_list_id: 列表中最小的 事务 ID
- low_limit_id: 系统尚未分配的下一个事务 ID

## Purge 线程

MySQL 的 Purge 线程主要负责清理已经不再需要的 undo 日志，这是为了释放存储空间并保持系统性能。 如果一直不清理链条会很长，占用空间，影响性能
在 InnoDB 存储引擎中，当事务被提交后，相关的 undo 日志就不再需要了，但这些日志并不会立即被删除，而是通过 Purge 线程异步清理

[参考](https://www.bilibili.com/video/BV1EM4y1c7nk?p=11&vd_source=29954a52608497ee1a304ca105f8cb17)
