## 乱序

cpu 通过乱序，先执行耗时较长的内存操作这类指令，同时执行短耗时指令，这样最终耗时取只有最长耗时

## 编程技巧

dcl: double check lock 双重锁定

缓存一致性： 在多线程的`共享变量`前后前后设置 64 字节， 保证 CPU 高速缓冲器独占缓冲块；共享变量通常是高频访问

## 原子指令

原子指令，对其他线程的可见性,有序性；
就是说一个并发程序中，原子指令的那条代码，在不同线程或进程中它们的关系是串行的，一定有先后关系，取决于谁先谁后。所有的状态变化也是及时可见的

原理：原子指令会给总线上锁，停止其他所有工作 pipeline

屏障指令阻止他前后的两条指令乱序执行

## 原子函数的实现

- 包含一个原子指令，也就是不能被打断的汇编指令，例如 lock、xchg
- 包含一个 compile barrier，编译器不对其进行优化
- 包含一个 memory fence，保证可见性
