## 创建文件的步骤

## Crash Recovery

文件存在硬盘上的数据是次持久化，正常来想的话，遇到突发的断电、系统崩溃这种情况，磁盘应该不受影响，或者说不会丢失数据。是这样的吗？

实际上文件系统在使用过程中，是有**多个步骤**的，突发情况会造成一些信息不一致的问题，想下这些问题

1. 文件进行了写入，但是文件描述符没有更新偏移，发生了故障
2. 创建一个文件未完成时崩溃
3. ...

问题基本上都是因为操作未完成，读写相关信息都还在内存中没来得急写入到硬盘

## lose inode

发生在创建一个时，步骤执行到`init inode n`，突然崩溃了

这个时候，这个数据块被标记成了已使用，但是并没有真正的写入数据，还有一些重要的信息没有写入，用户根本无法看到这个文件，也无法使用它了，甚至无法删除

---

一个可能想法是，先写入各种信息和数据，最后标记为已使用；

这任然是有问题的，第一次创建时最后崩溃没有标记为已使用，第二次创建文件如果又分配到了这个 inode，现在就有两个文件指向同一个 inode，创建这两个的用户甚至可能不是同一个用户，但是他们现在共同拥有了同一个 inode

简单的说就是磁盘实际使用大小与文件系统记录的大小不匹配，一个可怕行为是，同一个 inode 分配给了不同用户文件，他们都有读写权限

---

有一个结论是，文件系统遭遇突发崩溃，想要靠调整文件系统步骤是无法保证绝对可靠的，所有步骤需要是原子性的，这在目前物理世界来看是不可能的；**日志文件系统**登场
