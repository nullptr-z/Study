_应用层协议常常被开发者，误以为是网络应用程序的一部分，实际它应该属于网络协议部分_

1. 如何构造报文？
2. 报文中各个字段的含义？
3. 何时发送报文？

## HTTP 协议--超文本传输协议

当今 web 的核心,它分为客户端和服务端，通过交换 http 报文进行回话

- 使用 TCP 协议作为运输载体,使用套接字接口与之 TCP 收发报文，一旦向套接字接口发送一个请求报文（与 TCP 链接），这个报文就脱离控制，完全由 TCP 接管
- HTTP 是**无状态协议**，每次请求都是独立存在，服务器不会保存来自同一客户的信息；通过 Cookie、session 能保持状态
- HTTP 与 TCP 默认使用`持续性链接`（即，所有请求/响应使用相同的 TCP 链接），但是也能配置成`非持续链接`

- 请求报文至少一行

- 非持续性链接：

  > 如果在网页访问中服务器要返回 N 个资源（文件、图片），那么每个资源都会经历 TCP 链接/断开, 至少 N\*2 个 RTT，经历三次握手

- 持续性链接：

  > 一个完整的 web 页面，使用单个持续 TCP 链接进行传送
  > 可以连续发出请求（流水线，串行）

## HTTP1.x 半双工

客户端没有发起请求时，服务端不能主动推数据；
请求的顺序和响应的顺序一一对应，不会乱序，这是一种**应用层列头阻塞**的通讯

## HTTP2:

> 二进制传输
> 同一域名下的链接使用一个 TCP 链接；一台服务器上的多个 web 页面，发送给同一个客户时也可以在一个持续 TCP 链接上进行
> 多路复用： HTTP2 请求和回答还可以是交错的（并行）
> Header 压缩，部首在持续连接中一直被缓存，只需要追加或者替换部首
> server push,服务器主动推送客户端会用到的文件，但是客户端可选择是否接受

- htt2 增加了哪些
  > 二进制传输
  > 多路复用，在服务器上对同一个域名下的的访问，多个 HTTP 连接贡献一个 TCP 连接，TCP 是持续的，只需要经历一次*三次握手*
  > 头部压缩
  > 服务端主动推送，减少客户请求

## HTTP3

基于 Quick 协议，基于 UDP

- 解决头了端阻塞问题

## 状态码

- 1XX 很少使用
- 2XX 表示请求成功被接受
- 3XX 表示重定向，客户端需要进一步操作才能完成请求
- 4XX 客户端的请求，服务器无法理解，无法处理请求。身份认证、权限问题、资源找不到
- 5XX 服务器内部错误，在处理请求过程中出现了错误；
- 502 网关或代理错误

200：请求成功，响应内容
301：请求对象被转移了，新的 URL 在响应报文 Location 中，客户端自动获取新的 URL
400：服务器无法识别的请求
404：错误 URL，服务器不存在的 URL
505：服务器不支持的 HTTP 协议版本

## 无状态协议

Cookie、session 将 HTTP 从无状态变成了有状态，意思就是服务器通过 Cookie 信息，知道了客户端是谁

## Cookie

通过过期时间让 Cookie 失效，容量 4KB

1. 用户和服务器首次通信时，由服务器创建的一个 ID，作为用户身份标识 ID 颁发给客户端
2. 客户端发起请时，会携带 ID 和其他 Cookie 数据一起发送给服务器

Cookie 有很多应用场景，常被用于记录你的姓名、电话、信用卡号、邮件地址等，它所以他不是安全，不应该用于存储敏感信息

> 购物网站可以向你推荐你想买的物品
> 搜索记录
> 方便浏览器自动填充表单信息

存储用户的站点访问信息，这些信息对`任何站点都是公开`的。例如你在访问京东可以读取你在淘宝留下的信息

## Session

关闭浏览器或超时就会失效，主要数据存储在服务器，容量大

1. 同样用户和服务器首次通信时，由服务器创建的一个 ID，作为用户身份标识 ID 颁发给客户端
2. 服务器收到 ID， 就能找到这个客户端对应的信息

## Web 缓存器/代理服务器

- GET：在 get 请求报文中添加`If-Modified-Since`首部行

- 更新缓存
  > 缓冲器向服务器发起请求，并在`If-Modified-Since`中填入，上一次服务器响应的`Last-Modified`的时间
  > 如果服务器检查时间，如果在这候之后网页已经发生修改，则在响应报文中返回对象；
  > 没有则响应对象为空，并且状态码为‘304’: 表明没有发生更改，副本任然有效

CDN，位于客户和服务器之间，既是客户也是服务
如果有缓存返回客户网页副本；如果没有则向服务器请求，并保存副本

> 减少服务对客户的响应时间
> 减少服务器成本，例如算力、带宽
> ISP 中的缓存器还能减少，直接对 Intent 层的访问

## CGI

公共网关接口（Common Gateway Interface，CGI）是 Web 服务器运行时外部程序的规范，按 CGI 编写的程序可以扩展服务器功能。CGI 应用程序能与浏览器进行交互，还可通过数据 API 与数据库服务器等外部数据源进行通信，从数据库服务器中获取数据。格式化为 HTML 文档后，发送给浏览器，也可以将从浏览器获得的数据放到数据库中。几乎所有服务器都支持 CGI，可用任何语言编写 CGI，包括流行的 C、C ++、Java、VB 和 Delphi 等。

## 应用层的数据与控制

数据与控制混合在一起的时候，大容量数据传输会导致阻塞后续的简短指令传输

> 控制链接：建立一个长连接，用于交互式命令，
> 数据连接：当遇到大容量数据传输的时候，创建一个新的临时链接，专门用于传输这组大量数据

## 协议的基本格式

```sh
# 请求方式GET/POST API(uri) HTTP/版本 结束符号
# Method Request-URI HTTP/Version CRLF
GET / HTTP/1.1
Host: 127.0.0.1:8899

# uri: 是 HTTP 中的术语,URL 去除 `IP:port`(host)的部分, 每个`/`一个节点
# 非管理员用户只能监听大于 1024 的端口

### 响应

# HTTP 版本 状态码 短语 CRLF
# 一个使用 HTTP 1.1 版本的响应例子，其状态码为 200，短语为 OK

HTTP/1.1 200 OK
# 此处为header
# 此处为body
```
